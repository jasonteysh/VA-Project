---
title: "louelle draft"
author: "Louelle Teo"
date: "06/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.retina = 3, 
                      message = FALSE,
                      warning = FALSE)
```

#Load Data

```{r}

library(tidyverse)
library(lubridate)
library(anytime)
library(shiny)
library(shinydashboard)
library(plotly)
library(corrplot)
library(heatmaply)
library(dplyr)
library(MASS)
library(parallelPlot)

airbnb <- read_csv("data/Airbnb.csv")

```

##Sidebar

``` {r}

sidebar <- dashboardSidebar(
  sidebarMenu(
    menuItem("EDA" ,tabName = "EDA", icon = icon("globe")),
    menuItem("Cluster Analysis",tabName = "Cluster Analysis", icon = icon("dashboard")),
    menuItem("Spatial Cluster Analysis",tabName = "Spatial Cluster Analysis", icon = icon("dashboard")),
    menuItem("Text Analysis", tabName = "Text Analysis", icon = icon("chart-line")),
    menuItem("MLR", tabName = "MLR", icon = icon("chart-line"))
            )
)

```

##Body

``` {r}
body <- dashboardBody(
  tabItems(

################################EDA##############################################

    tabItem(tabName = "EDA",
      fluidPage(
        titlePanel("Exploratory Data Analysis"),
        fluidRow(
          column(
            width=12,
            tabsetPanel(
              tabPanel("Bivariate Analysis",
                       box(
                      selectInput("variable_region", "Region:",
                                c('All Regions'=0,sort(unique(airbnb$region_parent_name))),
                                  selected = "Victoria"
                                  ),
                       selectInput("variable_x_bivariate", "X Variable:",
                                   c("Host Response Rate" =  "host_response_rate",
                                     "Host Acceptance Rate" =  "host_acceptance_rate",
                                     "Host Total Listings Count" =  "host_total_listings_count",
                                     "Accommodates" =  "accommodates",
                                     "Bedrooms" =  "bedrooms",
                                     "Beds" =  "beds",
                                     "Price" =  "price",
                                     "Number Of Reviews" =  "number_of_reviews",
                                     "Review Scores Rating" =  "review_scores_rating",
                                     "Review Scores Accuracy" =  "review_scores_accuracy",
                                     "Review Scores Cleanliness" =  "review_scores_cleanliness",
                                     "Review Scores Checkin" =  "review_scores_checkin",
                                     "Review Scores Communication" =  "review_scores_communication",
                                     "Review Scores Location" =  "review_scores_location",
                                     "Review Scores Value" =  "review_scores_value"),
                                   selected = "review_scores_rating"
                       ),
                       selectInput("variable_y_bivariate", "Y Variable:",
                                   c("Host Response Rate" =  "host_response_rate",
                                     "Host Acceptance Rate" =  "host_acceptance_rate",
                                     "Host Total Listings Count" =  "host_total_listings_count",
                                     "Accommodates" =  "accommodates",
                                     "Bedrooms" =  "bedrooms",
                                     "Beds" =  "beds",
                                     "Price" =  "price",
                                     "Number Of Reviews" =  "number_of_reviews",
                                     "Review Scores Rating" =  "review_scores_rating",
                                     "Review Scores Accuracy" =  "review_scores_accuracy",
                                     "Review Scores Cleanliness" =  "review_scores_cleanliness",
                                     "Review Scores Checkin" =  "review_scores_checkin",
                                     "Review Scores Communication" =  "review_scores_communication",
                                     "Review Scores Location" =  "review_scores_location",
                                     "Review Scores Value" =  "review_scores_value"),
                                   selected = "price"
                       ),),
                       box(width=12,
                           title = "Bivariate Analysis",
                           plotlyOutput(outputId = "bivariateplot")),
                       box(width=7,
                           title = "Confidence Interval of X",
                       tableOutput(outputId = "bivariateX")),
                       box(width=7,
                           title = "Confidence Interval of Y",
                       tableOutput(outputId = "bivariateY"))
                       
              ),
              tabPanel("Correlation Analysis",
                      plotOutput("corrplotEDA",
                      width="800px",
                      height="800px")
                      #"asd"
                      )
              )
          )
        )
      )      
    ),

################################MLR##############################################

    tabItem(tabName = "MLR",
            fluidPage(
              titlePanel("Multiple linear regression"),
              fluidRow(
                column(
                  width = 12,
                  height = 100,
                  tabsetPanel(
                    tabPanel("Regression for Price",
                             box(width = 12,
                               height = 240,
                               selectInput("mlr1", "Independent Variables:",
                                           choices = c("host_acceptance_rate", "host_total_listings_count", "accommodates", "bedrooms", "beds", "number_of_reviews", "review_scores_rating", "review_scores_accuracy", "review_scores_cleanliness", "review_scores_checkin", "review_scores_communication", "review_scores_location", "review_scores_value")
                                           ,multiple = TRUE,selected = c("host_acceptance_rate", "host_total_listings_count", "accommodates", "bedrooms", "beds", "number_of_reviews", "review_scores_rating", "review_scores_accuracy", "review_scores_cleanliness", "review_scores_checkin", "review_scores_communication", "review_scores_location", "review_scores_value")
                               ),
                               selectInput("variable_selection", "Strategies of Stepwise:",
                                           choices =  list("Forward Selection", "Backward Selection", "Stepwise Selection"))
                               ),
                             box(
                               width = 12,
                               h4('Regression Summary:'),
                               verbatimTextOutput("MLR"))
                                ))))))
###########################################################################
  )
)

```

```{r}

ui <- dashboardPage(
  dashboardHeader(title = "Airbnb Analysis"),
  sidebar,
  body
)

```


``` {r}
server<-function(input,output){
  
#############output bivariate plot#########################
output$bivariateplot <- renderPlotly({
  
  if(input$variable_region==0){
  
xaxis <- unlist(airbnb[,input$variable_x_bivariate])
yaxis <- unlist(airbnb[,input$variable_y_bivariate])

ggplot(airbnb,aes(x=xaxis,y=yaxis, color=region_parent_name))+
  geom_jitter()+
  labs(title=paste(input$variable_x_bivariate, "Vs", input$variable_y_bivariate), y = input$variable_y_bivariate, x=input$variable_x_bivariate)+
  theme(legend.position="bottom", axis.text.y = element_text(angle = 90))
  }
  
  else{
    
regionfilter <- filter(airbnb,(region_parent_name == input$variable_region))
xaxis <- unlist(regionfilter[,input$variable_x_bivariate])
yaxis <- unlist(regionfilter[,input$variable_y_bivariate])

ggplot(regionfilter,aes(x=xaxis,y=yaxis, color=regionfilter$region_parent_name))+
  geom_jitter()+
  labs(title=paste(input$variable_x_bivariate, "Vs", input$variable_y_bivariate), y = input$variable_y_bivariate, x=input$variable_x_bivariate)+
  theme(legend.position="bottom", axis.text.y = element_text(angle = 90))
  }
  })

################output Confidence Interval X####################
output$bivariateX <- renderTable({

   if(input$variable_region==0){
     
  airbnb2<- airbnb %>%
    summarise(Min = min(get(input$variable_x_bivariate), na.rm = TRUE), 
                  Max = max(get(input$variable_x_bivariate), na.rm = TRUE), 
                  Mean = mean(get(input$variable_x_bivariate), na.rm = TRUE),
                  Sd = sd(get(input$variable_x_bivariate), na.rm = TRUE),
                  Median = median(get(input$variable_x_bivariate), na.rm = TRUE),
                  Count = n())
  airbnb2$lower_CI <- airbnb2$Mean - qnorm(0.975)* airbnb2$Sd/sqrt(airbnb2$Count)
  airbnb2$upper_CI <- airbnb2$Mean + qnorm(0.975)* airbnb2$Sd/sqrt(airbnb2$Count)
      
return(airbnb2)
   }
  else{
    
regionfilterX <- filter(airbnb,(region_parent_name == input$variable_region))

  airbnb2<- regionfilterX %>%
    summarise(Min = min(get(input$variable_x_bivariate), na.rm = TRUE), 
                  Max = max(get(input$variable_x_bivariate), na.rm = TRUE), 
                  Mean = mean(get(input$variable_x_bivariate), na.rm = TRUE),
                  Sd = sd(get(input$variable_x_bivariate), na.rm = TRUE),
                  Median = median(get(input$variable_x_bivariate), na.rm = TRUE),
                  Count = n())
  airbnb2$lower_CI <- airbnb2$Mean - qnorm(0.975)* airbnb2$Sd/sqrt(airbnb2$Count)
  airbnb2$upper_CI <- airbnb2$Mean + qnorm(0.975)* airbnb2$Sd/sqrt(airbnb2$Count)
      
return(airbnb2)
  
    
  }
})

#########################output Confidence Interval Y######################
output$bivariateY <- renderTable({

if(input$variable_region==0){  
  
  airbnb3<- airbnb %>%
    summarise(Min = min(get(input$variable_y_bivariate), na.rm = TRUE), 
                  Max = max(get(input$variable_y_bivariate), na.rm = TRUE), 
                  Mean = mean(get(input$variable_y_bivariate), na.rm = TRUE),
                  Sd = sd(get(input$variable_y_bivariate), na.rm = TRUE),
                  Median = median(get(input$variable_y_bivariate), na.rm = TRUE),
                  Count = n())
  airbnb3$lower_CI <- airbnb3$Mean - qnorm(0.975)* airbnb3$Sd/sqrt(airbnb3$Count)
  airbnb3$upper_CI <- airbnb3$Mean + qnorm(0.975)* airbnb3$Sd/sqrt(airbnb3$Count)
      
return(airbnb3)
     }
  else{
    
regionfilterY <- filter(airbnb,(region_parent_name == input$variable_region))
    
      airbnb3<- regionfilterY %>%
    summarise(Min = min(get(input$variable_y_bivariate), na.rm = TRUE), 
                  Max = max(get(input$variable_y_bivariate), na.rm = TRUE), 
                  Mean = mean(get(input$variable_y_bivariate), na.rm = TRUE),
                  Sd = sd(get(input$variable_y_bivariate), na.rm = TRUE),
                  Median = median(get(input$variable_y_bivariate), na.rm = TRUE),
                  Count = n())
  airbnb3$lower_CI <- airbnb3$Mean - qnorm(0.975)* airbnb3$Sd/sqrt(airbnb3$Count)
  airbnb3$upper_CI <- airbnb3$Mean + qnorm(0.975)* airbnb3$Sd/sqrt(airbnb3$Count)
  
  return(airbnb3)
    
  }
  
})

##################Output Corr Plot########################

output$corrplotEDA <- renderPlot({
  airbnb.cor <- dplyr::select(airbnb,c(11, 12, 15, 24, 26, 27, 29, 43, 48, 49, 50, 51, 52, 53, 54))
airbnb.cor2 <- cor(airbnb.cor,use = "complete.obs")
corrplot(airbnb.cor2,
         method = "ellipse",
         type="lower",
         diag = FALSE,
         tl.col = "black",
         order = "hclust")
})

####################Output MLR###########################

output$MLR <- renderPrint({
  airbnb.mlr <- dplyr::select(airbnb,c(11, 12, 15, 24, 26, 27, 29, 43, 48, 49, 50, 51, 52, 53, 54))
  variablesxMlr<-c("price",input$mlr1)
  Rdata = airbnb.mlr[,variablesxMlr]
  Rdata<-na.omit(Rdata)
    fit1<-lm(price ~.,data=Rdata)
    fit2<-lm(price ~1,data=Rdata)
    
if (input$variable_selection == "Backward Selection") {
      step<- stepAIC(fit1,direction = "backward")
      
    } else if (input$variable_selection == "Forward Selection") {
      step<- stepAIC(fit2,direction = "forward",scope = list(upper = fit1,lower = fit2))
      
    } else {
      step<- stepAIC(fit2,direction = "both",scope = list(upper = fit1,lower = fit2))
    }
    return(summary(step))
  })

######################################################

}

shinyApp(ui=ui,server=server)


```




airbnb.cluster <- dplyr::select(airbnb,c(price,bedrooms, beds, region_parent_name))
airbnb.cluster$region_parent_name <- as.factor(airbnb.cluster$region_parent_name)
airbnb.cluster<- data.frame(airbnb.cluster)
airbnb.cluster <- na.omit(airbnb.cluster)
airbnb.cluster <- filter(airbnb.cluster,(airbnb.cluster$region_parent_name == "victoria"))
class(airbnb.cluster$region_parent_name)
class(airbnb.cluster$price)
class(airbnb.cluster)
summary(airbnb.cluster)
parallelPlot(airbnb.cluster)




parallelPlot(iris)
summary(iris)
class(iris$Species)
class(iris)
class(iris$Sepal.Width)
data.frame(iris)

parallelPlot(mtcars)




